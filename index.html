<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Undercover - Gioco di parole</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #fff;
      margin: 0;
      padding: 0;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
    }
    form, .game-area {
      width: 100%;
      max-width: 500px;
    }
    input, button, select, textarea {
      width: 100%;
      padding: 0.7rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-sizing: border-box;
    }
    button {
      background-color: #007aff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .player-list {
      list-style: none;
      padding: 0;
    }
    .player-list li {
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    #toggleRolesBtn {
      margin-bottom: 1rem;
      background-color: #555;
    }
  </style>
</head>
<body>
  <h1>Gioco Undercover</h1>
  <form id="setupForm">
    <label for="players">Inserisci i nomi dei giocatori (uno per riga, nell'ordine):</label>
    <textarea id="players" rows="6" placeholder="Es. Luca\nGiulia\nMarco..."></textarea>

    <label for="numUndercover">Numero di Undercover:</label>
    <input type="number" id="numUndercover" min="0" max="5" value="1">

    <label for="includeWhite">Includi Mister White?</label>
    <select id="includeWhite">
      <option value="yes">Sì</option>
      <option value="no">No</option>
    </select>

    <button type="submit">Inizia Partita</button>
  </form>

  <!-- MODIFICA: Box per mostrare i ruoli uno alla volta -->
  <div id="showRoleBox" style="display:none; max-width:500px; margin:2rem auto; text-align:center; background:#f7f7f7; border-radius:10px; padding:2rem;">
    <h2 id="showRoleTitle"></h2>
    <div id="roleRevealArea" style="margin:1rem 0;"></div>
    <button id="showRoleBtn" style="margin-top:1rem;">Mostra il mio ruolo</button>
  </div>

  <div class="game-area" id="gameArea" style="display:none;">
    <h2>Ruoli assegnati</h2>
    <button id="toggleRolesBtn" type="button">Nascondi Ruoli</button>
    <ul class="player-list" id="playerRoles"></ul>
    <button id="voteBtn" type="button" style="display:none; margin-top:1rem;">Al voto</button>
    <div id="voteArea" style="display:none; max-width:500px; margin-top:1rem;"></div>
    <div id="resultArea" style="display:none; max-width:500px; margin-top:1rem; font-weight:bold;"></div>
  </div>

  <script>
    const wordPairs = [
      ["pisello", "melanzana"], ["skincare", "makeup"],  ["streamer", "youtuber"],
["manga", "anime"], ["eren", "levi"], ["tiktok", "instagram"], ["harry", "draco"],
["tette", "culo"], ["sanremo", "eurovision"], ["character ai", "chatgpt"], ["mutande", "boxer"],
["anna pepe", "tony effe"], ["scorreggia", "puzza"], ["banana", "cetriolo"],
["kpop", "jpop"], ["anguria", "mango"], ["labubu", "pokemon"], ["anna pepe", "baddie"], ["favij", "cicciogamer"], 
      ["zeb89", "dario moccia"], ["maranza", "incel"], ["alberto angela", "geopop"], ["misoginia", "misandria"], ["giappone","corea"], ["addominali", "tartaruga"], 
      ["calippo", "polaretti"]
    ];

    // Funzione per ottenere le coppie già uscite da localStorage
    function getUsedPairs() {
      const used = localStorage.getItem("usedWordPairs");
      return used ? JSON.parse(used) : [];
    }

    // Funzione per salvare una nuova coppia uscita
    function saveUsedPair(pair) {
      const used = getUsedPairs();
      used.push(pair);
      localStorage.setItem("usedWordPairs", JSON.stringify(used));
    }

    // Funzione per filtrare le coppie già uscite
    function getAvailablePairs() {
      const used = getUsedPairs();
      return wordPairs.filter(pair =>
        !used.some(usedPair =>
          (usedPair[0] === pair[0] && usedPair[1] === pair[1]) ||
          (usedPair[0] === pair[1] && usedPair[1] === pair[0])
        )
      );
    }

    // Pulsante per azzerare le coppie uscite (opzionale)
    // Puoi aggiungere questo bottone dove vuoi nell'HTML:
    // <button id="resetPairsBtn" type="button">Reset parole uscite</button>
    // E questo codice JS:
    /*
    document.getElementById("resetPairsBtn").onclick = function() {
      localStorage.removeItem("usedWordPairs");
      alert("Parole uscite azzerate!");
    };
    */

    let players = [];
let roles = [];
let civilWord = "";
let undercoverWord = "";
let eliminated = []; // Array per tenere traccia degli eliminati
let primoGiocatoreIdx = null;

// MODIFICA: Variabili per la visualizzazione dei ruoli uno alla volta
let currentRoleIdx = 0;

function startRoleReveal() {
  currentRoleIdx = 0;
  document.getElementById("gameArea").style.display = "none";
  document.getElementById("showRoleBox").style.display = "block";
  showNextWord();
}

function showNextWord() {
  const title = document.getElementById("showRoleTitle");
  const area = document.getElementById("roleRevealArea");
  const btn = document.getElementById("showRoleBtn");
  area.textContent = "";
  btn.textContent = "Mostra la mia parola";
  btn.disabled = false;

  if (currentRoleIdx < players.length) {
    title.textContent = `Giocatore: ${players[currentRoleIdx]}`;
    btn.onclick = function() {
      let role = roles[currentRoleIdx];
      let word = role === "Undercover" ? undercoverWord : (role === "Mister White" ? "???" : civilWord);
      area.innerHTML = `<span style="font-size:1.3rem;">La tua parola: <b>${word}</b></span>`;
      btn.textContent = currentRoleIdx === players.length - 1 ? "Procedi al voto" : "Passa al prossimo";
      btn.onclick = function() {
        currentRoleIdx++;
        showNextWord();
      };
    };
  } else {
    // Tutti hanno visto la parola, scegli chi inizia (escludendo Mister White)
    document.getElementById("showRoleBox").style.display = "none";
    document.getElementById("gameArea").style.display = "block";
    document.getElementById("playerRoles").style.display = "none";
    document.getElementById("toggleRolesBtn").style.display = "none";
    document.getElementById("voteBtn").style.display = "none";
    // Scegli casualmente chi inizia tra chi NON è Mister White
    let possibili = players.map((_, i) => i).filter(i => roles[i] !== "Mister White");
    primoGiocatoreIdx = possibili[Math.floor(Math.random() * possibili.length)];
    const starterName = players[primoGiocatoreIdx];
    document.getElementById("resultArea").innerHTML = `<b>Inizia:</b> ${starterName}<br>Descrivi la tua parola!<br><br><button id="proseguiAlVotoBtn">Prosegui al voto</button>`;
    document.getElementById("resultArea").style.display = "block";
    // Mostra il bottone per passare al voto solo dopo la descrizione
    document.getElementById("proseguiAlVotoBtn").onclick = function() {
      document.getElementById("resultArea").style.display = "none";
      document.getElementById("voteBtn").style.display = "inline-block";
    };
  }
}

    // Funzione per rendere casuali gli elementi di un array
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // Funzione per aggiornare la lista dei giocatori e ruoli
    function renderPlayerList() {
      const list = document.getElementById("playerRoles");
      list.innerHTML = "";

      // Mostra il primo giocatore in alto
      if (primoGiocatoreIdx !== null && !eliminated.includes(primoGiocatoreIdx)) {
        const name = players[primoGiocatoreIdx];
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.alignItems = "center";
        li.style.justifyContent = "space-between";
        li.style.background = "#e6f7ff";
        li.style.fontWeight = "bold";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = `Primo a iniziare: ${name}`;

        const roleSpan = document.createElement("span");
        if (roles[primoGiocatoreIdx] === "Mister White") {
          roleSpan.textContent = "???";
        } else {
          roleSpan.textContent = roles[primoGiocatoreIdx] === "Undercover" ? undercoverWord : civilWord;
        }
        roleSpan.style.display = "none";
        roleSpan.style.marginLeft = "1rem";

        const btn = document.createElement("button");
        btn.textContent = "Mostra ruolo";
        btn.style.width = "auto";
        btn.style.marginLeft = "1rem";
        btn.addEventListener("click", function() {
          if (roleSpan.style.display === "none") {
            roleSpan.style.display = "inline";
            btn.textContent = "Nascondi ruolo";
          } else {
            roleSpan.style.display = "none";
            btn.textContent = "Mostra ruolo";
          }
        });

        li.appendChild(nameSpan);
        li.appendChild(btn);
        li.appendChild(roleSpan);
        list.appendChild(li);
      }

      // Mostra gli altri giocatori nell’ordine, saltando il primo e gli eliminati
      players.forEach((name, index) => {
        if (index === primoGiocatoreIdx || eliminated.includes(index)) return;
        let word = roles[index] === "Undercover" ? undercoverWord : (roles[index] === "Mister White" ? "???" : civilWord);
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.alignItems = "center";
        li.style.justifyContent = "space-between";

        const nameSpan = document.createElement("span");
        nameSpan.textContent = name;

        const roleSpan = document.createElement("span");
        if (roles[index] === "Mister White") {
          roleSpan.textContent = "???";
        } else {
          roleSpan.textContent = word;
        }
        roleSpan.style.display = "none";
        roleSpan.style.marginLeft = "1rem";

        const btn = document.createElement("button");
        btn.textContent = "Mostra ruolo";
        btn.style.width = "auto";
        btn.style.marginLeft = "1rem";
        btn.addEventListener("click", function() {
          if (roleSpan.style.display === "none") {
            roleSpan.style.display = "inline";
            btn.textContent = "Nascondi ruolo";
          } else {
            roleSpan.style.display = "none";
            btn.textContent = "Mostra ruolo";
          }
        });

        li.appendChild(nameSpan);
        li.appendChild(btn);
        li.appendChild(roleSpan);
        list.appendChild(li);
      });
    }

    document.getElementById("setupForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const playerLines = document.getElementById("players").value.trim().split("\n");
      const numUndercover = parseInt(document.getElementById("numUndercover").value);
      const includeWhite = document.getElementById("includeWhite").value === "yes";

      if (playerLines.length < numUndercover + (includeWhite ? 1 : 0) + 2) {
        alert("Troppi ruoli rispetto al numero di giocatori!");
        return;
      }

      players = playerLines.map(name => name.trim()).filter(name => name);
      shuffle(players);

      // --- MODIFICA QUI: scegli solo tra le coppie non uscite ---
      const availablePairs = getAvailablePairs();
      if (availablePairs.length === 0) {
        alert("Tutte le coppie di parole sono già uscite! Premi il pulsante di reset per ricominciare.");
        return;
      }
      [civilWord, undercoverWord] = availablePairs[Math.floor(Math.random() * availablePairs.length)];
      saveUsedPair([civilWord, undercoverWord]);
      // --- FINE MODIFICA ---

      roles = Array(players.length).fill("Civile");
      for (let i = 0; i < numUndercover; i++) roles[i] = "Undercover";
      if (includeWhite) roles[numUndercover] = "Mister White";
      shuffle(roles);

      // Scegli il primo giocatore (non Mister White)
      let possibili = players.map((_, i) => i).filter(i => roles[i] !== "Mister White");
      primoGiocatoreIdx = possibili[Math.floor(Math.random() * possibili.length)];

      eliminated = [];
      // Nascondi il form di setup
      document.getElementById("setupForm").style.display = "none";
      // Avvia la visualizzazione dei ruoli uno alla volta
      startRoleReveal();
    });

    document.getElementById("toggleRolesBtn").addEventListener("click", function() {
      const list = document.getElementById("playerRoles");
      if (list.style.display === "none") {
        list.style.display = "block";
        this.textContent = "Nascondi Ruoli";
      } else {
        list.style.display = "none";
        this.textContent = "Mostra Ruoli";
      }
    });

    // Sistema di voto aggiornato
    document.getElementById("voteBtn").addEventListener("click", function() {
      const voteArea = document.getElementById("voteArea");
      voteArea.innerHTML = "<h3>Vota chi eliminare:</h3>";
      voteArea.style.display = "block";
      document.getElementById("resultArea").style.display = "none";
      players.forEach((name, idx) => {
        if (eliminated.includes(idx)) return; // Salta eliminati
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.style.margin = "0.3rem";
        btn.addEventListener("click", function() {
          voteArea.style.display = "none";
          eliminated.push(idx); // Segna come eliminato
          renderPlayerList(); // Aggiorna lista

          // Controllo vittoria Mister White
          const inGioco = players
            .map((_, i) => i)
            .filter(i => !eliminated.includes(i));
          const restanti = inGioco.map(i => roles[i]);
          if (restanti.length === 1 && restanti[0] === "Mister White") {
            document.getElementById("resultArea").textContent = "Ha vinto Mr White!";
            document.getElementById("resultArea").style.display = "block";
            showRestartButtons();
            return;
          }

          // --- AGGIUNTA: Controllo vittoria Undercover ---
          // Se 2 o più undercover restano con un civile, vincono gli undercover
          const undercoverCount = inGioco.filter(i => roles[i] === "Undercover").length;
          const civilCount = inGioco.filter(i => roles[i] === "Civile").length;
          const misterWhiteCount = inGioco.filter(i => roles[i] === "Mister White").length;
          if (undercoverCount >= 2 && civilCount === 1 && misterWhiteCount === 0) {
            document.getElementById("resultArea").innerHTML =
              "Hanno vinto gli Undercover!<br><br>" +
              "<b>Parola Civili:</b> " + civilWord + "<br>" +
              "<b>Parola Undercover:</b> " + undercoverWord;
            document.getElementById("resultArea").style.display = "block";
            showRestartButtons();
            return;
          }
          // Se resta solo un undercover senza civili, vince lui
          if (undercoverCount === 1 && civilCount === 0 && misterWhiteCount === 0) {
            document.getElementById("resultArea").innerHTML =
              "Ha vinto l'Undercover!<br><br>" +
              "<b>Parola Civili:</b> " + civilWord + "<br>" +
              "<b>Parola Undercover:</b> " + undercoverWord;
            document.getElementById("resultArea").style.display = "block";
            showRestartButtons();
            return;
          }
          // Se vengono eliminati tutti i civili, vince Mister White e si ricomincia
          if (civilCount === 0 && misterWhiteCount > 0) {
            document.getElementById("resultArea").innerHTML =
              "Tutti i civili sono stati eliminati!<br><br>" +
              "Ha vinto Mister White!<br><br>" +
              "<b>Parola Civili:</b> " + civilWord + "<br>" +
              "<b>Parola Undercover:</b> " + undercoverWord;
            document.getElementById("resultArea").style.display = "block";
            showRestartButtons();
            return;
          }
          // --- FINE AGGIUNTA ---

          const role = roles[idx];
          if (role === "Civile") {
            document.getElementById("resultArea").textContent = "Un civile è stato eliminato.";
            document.getElementById("resultArea").style.display = "block";
          } else if (role === "Undercover") {
            // Controlla se Mister White è già stato eliminato (e ha già giocato il suo turno)
            const misterWhiteEliminato = players.some((_, i) => roles[i] === "Mister White" && eliminated.includes(i));
            if (misterWhiteEliminato) {
              // Se Mister White è stato eliminato, la partita termina subito
              document.getElementById("resultArea").innerHTML =
                "L'Undercover è stato eliminato!<br><br>" +
                "La partita è terminata.<br><br>" +
                "<b>Parola Civili:</b> " + civilWord + "<br>" +
                "<b>Parola Undercover:</b> " + undercoverWord;
              document.getElementById("resultArea").style.display = "block";
              showRestartButtons();
              return;
            } else {
              // Altrimenti, solo mostra che è stato eliminato (la partita continua finché Mister White non viene eliminato e gioca il suo turno)
              document.getElementById("resultArea").textContent = "Un undercover è stato eliminato.";
              document.getElementById("resultArea").style.display = "block";
            }
            return;
          } else if (role === "Mister White") {
            // Mister White deve indovinare la parola
            document.getElementById("resultArea").innerHTML = `
              Mister White è stato eliminato!<br>
              Prova a indovinare la parola comune dei civili:<br>
              <input type="text" id="whiteGuess" style="margin-top:0.5rem; text-transform:lowercase;">
              <button id="submitGuess" style="margin-left:0.5rem;">Conferma</button>
            `;
            document.getElementById("resultArea").style.display = "block";
            document.getElementById("submitGuess").onclick = function() {
              const guess = document.getElementById("whiteGuess").value.trim().toLowerCase();
              const target = civilWord.toLowerCase();
              // Calcolo percentuale di match
              function similarity(a, b) {
                let matches = 0;
                for (let i = 0; i < Math.min(a.length, b.length); i++) {
                  if (a[i] === b[i]) matches++;
                }
                return matches / b.length;
              }
              const perc = similarity(guess, target);

              // Stato attuale dei giocatori
              const inGioco = players.map((_, i) => i).filter(i => !eliminated.includes(i));
              const undercoverCount = inGioco.filter(i => roles[i] === "Undercover").length;
              const civilCount = inGioco.filter(i => roles[i] === "Civile").length;
              const misterWhiteCount = inGioco.filter(i => roles[i] === "Mister White").length;

              if (perc >= 0.7) {
                // Mister White ha vinto
                // Se Undercover è ancora in gioco, vincono entrambi
                if (undercoverCount > 0) {
                  document.getElementById("resultArea").innerHTML =
                    "Ha vinto Mr White e anche l'Undercover!<br><br>" +
                    "<b>Parola Civili:</b> " + civilWord + "<br>" +
                    "<b>Parola Undercover:</b> " + undercoverWord;
                } else {
                  document.getElementById("resultArea").innerHTML =
                    "Ha vinto Mr White!<br><br>" +
                    "<b>Parola Civili:</b> " + civilWord + "<br>" +
                    "<b>Parola Undercover:</b> " + undercoverWord;
                }
                showRestartButtons();
              } else {
                // Mister White ha fallito
                if (undercoverCount === 0) {
                  // Undercover già eliminato: partita finita
                  document.getElementById("resultArea").innerHTML =
                    "Mister White ha fallito!<br><br>" +
                    "La partita è terminata.<br><br>" +
                    "<b>Parola Civili:</b> " + civilWord + "<br>" +
                    "<b>Parola Undercover:</b> " + undercoverWord;
                  showRestartButtons();
                } else {
                  // La partita continua finché non viene eliminato l'Undercover o vince lui
                  document.getElementById("resultArea").innerHTML =
                    "Mister White ha fallito! Il gioco continua finché non viene eliminato l'Undercover o se vince lui.";
                  setTimeout(() => {
                    document.getElementById("resultArea").style.display = "none";
                    document.getElementById("voteBtn").style.display = "inline-block";
                  }, 2000);
                }
              }
            };
            return;
          }
        });
        voteArea.appendChild(btn);
      });
    });

    // Funzione per mostrare i pulsanti di restart
function showRestartButtons() {
  const resultArea = document.getElementById("resultArea");
  const btnRestart = document.createElement("button");
  btnRestart.textContent = "Rigioca con stessi giocatori";
  btnRestart.style.margin = "1rem 0.5rem 0 0";
  btnRestart.onclick = function() {
    // Reset variabili di gioco ma NON i giocatori
    eliminated = [];
    // Riassegna ruoli e parole e riparti dal reveal
    // --- scegli solo tra le coppie non uscite ---
    const availablePairs = getAvailablePairs();
    if (availablePairs.length === 0) {
      alert("Tutte le coppie di parole sono già uscite! Premi il pulsante di reset per ricominciare.");
      location.reload();
      return;
    }
    [civilWord, undercoverWord] = availablePairs[Math.floor(Math.random() * availablePairs.length)];
    saveUsedPair([civilWord, undercoverWord]);
    // --- FINE MODIFICA ---
    // Riassegna ruoli
    const numUndercover = roles.filter(r => r === "Undercover").length;
    const includeWhite = roles.includes("Mister White");
    roles = Array(players.length).fill("Civile");
    for (let i = 0; i < numUndercover; i++) roles[i] = "Undercover";
    if (includeWhite) roles[numUndercover] = "Mister White";
    shuffle(roles);
    // Scegli il primo giocatore (non Mister White)
    let possibili = players.map((_, i) => i).filter(i => roles[i] !== "Mister White");
    primoGiocatoreIdx = possibili[Math.floor(Math.random() * possibili.length)];
    // Nascondi tutto e riparti dal reveal
    document.getElementById("voteArea").style.display = "none";
    document.getElementById("resultArea").style.display = "none";
    document.getElementById("gameArea").style.display = "none";
    startRoleReveal();
  };

  const btnNew = document.createElement("button");
  btnNew.textContent = "Nuova partita";
  btnNew.style.margin = "1rem 0 0 0.5rem";
  btnNew.onclick = function() {
    location.reload();
  };

  // Rimuovi eventuali bottoni già presenti
  Array.from(resultArea.querySelectorAll("button")).forEach(b => b.remove());
  resultArea.appendChild(document.createElement("br"));
  resultArea.appendChild(btnRestart);
  resultArea.appendChild(btnNew);
}

// ...ripeti per tutti i punti di vittoria...
  </script>
</body>
</html>
